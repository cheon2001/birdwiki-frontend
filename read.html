<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdwiki ë¬¸ì„œ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
</head>
<body>
  <div id="header-container"></div>

  <div class="hero-section flush-to-header">
    <img id="cover-image" class="hero-background" />
    <button id="edit-button" class="hero-edit-button">âœï¸ ë¬¸ì„œ ìˆ˜ì •</button>
    <div class="hero-overlay">
      <h1 id="korean-name">êµ­ëª…</h1>
      <em id="scientific-name" class="sci-name"></em>
      <p id="english-name" class="eng-name"></p>
      <p id="classification">
        <span id="order"></span> &gt;
        <span id="family"></span> &gt;
        <span id="genus"></span>
      </p>
    </div>
  </div>

  <main class="article-page">
    <h2 id="doc-title"></h2>
    <article class="article-content">
      <div id="doc-content">ë¡œë”© ì¤‘...</div>
    </article>
  </main>

  <script>
fetch('header.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('header-container').innerHTML = html;

    // âœ… header.html ë‚´ë¶€ ìš”ì†Œ ë°”ì¸ë”©
    const input = document.getElementById('searchInput');
    const suggestions = document.getElementById('suggestions');

    if (!input || !suggestions) {
      console.warn("â— searchInput ë˜ëŠ” suggestions ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    input.addEventListener('input', async () => {
      const keyword = input.value.trim();
      if (!keyword) {
        suggestions.innerHTML = '';
        return;
      }

      try {
        const res = await fetch(`https://birdwiki.onrender.com/api/suggest?q=${encodeURIComponent(keyword)}`);
        const titles = await res.json();
        suggestions.innerHTML = '';
        titles.forEach(title => {
          const li = document.createElement('li');
          li.textContent = title;
          li.className = 'suggestion-item';
          li.addEventListener('click', () => {
            window.location.href = `read.html?title=${encodeURIComponent(title)}`;
          });
          suggestions.appendChild(li);
        });
      } catch (err) {
        console.error("âŒ ì¶”ì²œ ê²€ìƒ‰ì–´ ì˜¤ë¥˜:", err);
      }
    });

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const keyword = input.value.trim();
        if (keyword) {
          window.location.href = `read.html?title=${encodeURIComponent(keyword)}`;
        }
      }
    });
  });


    document.addEventListener("DOMContentLoaded", () => {
  const editBtn = document.getElementById("edit-button");
  if (editBtn) {
    const params = new URLSearchParams(window.location.search);
    const title = params.get("title");
    editBtn.addEventListener("click", () => {
      window.location.href = `write.html?title=${encodeURIComponent(title)}&edit=true`;
    });
  }
});

  </script>
  
  <script>
    const params = new URLSearchParams(window.location.search);
    const title = params.get('title');

    function renderContent(text) {
      let parsingReferenceBlock = false;
let referenceBuffer = [];
      const lines = text.split('\n');
      const container = document.getElementById('doc-content');
      container.innerHTML = '';
     let currentSection = container;
      let imageContainer = null;

lines.forEach(line => {
  if (line.startsWith('ğŸ“š ì°¸ê³ ë¬¸í—Œ:')) {
    parsingReferenceBlock = true;
    referenceBuffer = [line.replace('ğŸ“š ì°¸ê³ ë¬¸í—Œ:', '').trim()];
  } else if (parsingReferenceBlock) {
    if (line.startsWith('## ') || line.startsWith('### ') || line.startsWith('![')) {
      // ì°¸ê³ ë¬¸í—Œ ë¸”ë¡ ì¢…ë£Œ ì²˜ë¦¬
      const ref = document.createElement('div');
      ref.className = 'section-ref';
      ref.innerHTML = `<strong>ì°¸ê³ ë¬¸í—Œ:</strong><br>${referenceBuffer.join('<br>')}`;
      currentSection.appendChild(ref);
      parsingReferenceBlock = false;

      // ë‹¤ìŒ ì¤„ ì²˜ë¦¬ ê³„ì†
      if (line.startsWith('## ') || line.startsWith('### ')) {
        const tag = line.startsWith('## ') ? 'h2' : 'h3';
        const h = document.createElement(tag);
        h.textContent = line.replace(/^#+ /, '');
        h.className = tag === 'h3' ? 'subheading-title' : '';
        container.appendChild(h);
        currentSection = container;
} else if (line.startsWith('![')) {
  const altMatch = line.match(/!\[(.*?)\]\((.*?)\)/);
  if (altMatch) {
    const [_, alt, src] = altMatch;

    // âœ… í•­ìƒ ìƒˆ imageContainerë¥¼ ìƒì„±
    imageContainer = document.createElement('div');
    imageContainer.className = 'section-inline-images';
    currentSection.appendChild(imageContainer);

    const block = document.createElement('div');
    block.className = 'image-block';

    const img = document.createElement('img');
    img.src = src;
    img.alt = alt;
    img.className = 'section-image';

    const caption = document.createElement('p');
    caption.textContent = alt;
    caption.className = 'image-caption';

    block.appendChild(img);
    block.appendChild(caption);
    imageContainer.appendChild(block);
  }
}

    } else {
      referenceBuffer.push(line.trim());
    }
  } else if (line.startsWith('## ') || line.startsWith('### ')) {
    const tag = line.startsWith('## ') ? 'h2' : 'h3';
    const h = document.createElement(tag);
    h.textContent = line.replace(/^#+ /, '');
    h.className = tag === 'h3' ? 'subheading-title' : '';
    container.appendChild(h);
    currentSection = container;
  } else if (line.startsWith('![')) {
    const altMatch = line.match(/!\[(.*?)\]\((.*?)\)/);
    if (altMatch) {
      const [_, alt, src] = altMatch;
      if (!imageContainer) {
        imageContainer = document.createElement('div');
        imageContainer.className = 'section-inline-images';
        currentSection.appendChild(imageContainer);
      }
      const block = document.createElement('div');
      block.className = 'image-block';
      const img = document.createElement('img');
      img.src = src;
      img.alt = alt;
      img.className = 'section-image';
      const caption = document.createElement('p');
      caption.textContent = alt;
      caption.className = 'image-caption';
      block.appendChild(img);
      block.appendChild(caption);
      imageContainer.appendChild(block);
    }
  } else {
    // âœ… ì¼ë°˜ í…ìŠ¤íŠ¸ ë³¸ë¬¸ ì²˜ë¦¬
    if (line.trim() !== '') {
      const p = document.createElement('p');
      p.textContent = line;
      if (!currentSection) currentSection = container;
      currentSection.appendChild(p);
    }
  }
});
        // âœ… ë§ˆì§€ë§‰ ì¤„ì´ ì°¸ê³ ë¬¸í—Œìœ¼ë¡œ ëë‚¬ì„ ê²½ìš° ëŒ€ë¹„í•œ flush
  if (parsingReferenceBlock && referenceBuffer.length > 0) {
    const ref = document.createElement('div');
    ref.className = 'section-ref';
    ref.innerHTML = `<strong>ì°¸ê³ ë¬¸í—Œ:</strong><br>${referenceBuffer.join('<br>')}`;
    currentSection.appendChild(ref);
  }
    }

    if (!title) {
      document.getElementById('doc-title').textContent = 'âŒ ì œëª©ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
    } else {
      fetch(`https://birdwiki.onrender.com/api/wiki/${encodeURIComponent(title)}`)
        .then(res => res.ok ? res.json() : Promise.reject('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'))
        .then(data => {
          document.getElementById('korean-name').textContent = data.koreanName || data.title;
          document.getElementById('scientific-name').textContent = data.scientificName || '';
          document.getElementById('english-name').textContent = data.englishName || '';
          document.getElementById('order').textContent = data.order || '';
          document.getElementById('family').textContent = data.family || '';
          document.getElementById('genus').textContent = data.genus || '';
          if (data.coverImage) {
            document.getElementById('cover-image').src = data.coverImage;
          }
          renderContent(data.content);
        })
        .catch(err => {
          document.getElementById('doc-title').textContent = 'âŒ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ';
          document.getElementById('doc-content').textContent = err;
        });
    }

    // âœ… ìë™ì™„ì„± ê¸°ëŠ¥ ì¤‘ë³µ ë°©ì§€ ë° ì¤‘ë³µ í•­ëª© ì œê±°
    const input = document.getElementById('searchInput');
    const suggestionList = document.getElementById('suggestions');

    input.addEventListener('input', async () => {
      const query = input.value.trim();
      suggestionList.innerHTML = '';
      if (!query) return;

      try {
        const res = await fetch(`https://birdwiki.onrender.com/api/suggest?q=${encodeURIComponent(query)}`);
        const suggestions = await res.json();
        const uniqueTitles = [...new Set(suggestions)];

        uniqueTitles.forEach(title => {
          const li = document.createElement('li');
          li.textContent = title;
          li.className = 'suggestion-item';
          li.onclick = () => {
            window.location.href = `read.html?title=${encodeURIComponent(title)}`;
          };
          suggestionList.appendChild(li);
        });
      } catch (err) {
        console.error('ìë™ì™„ì„± ì˜¤ë¥˜', err);
      }
    });

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = input.value.trim();
        if (query) {
          window.location.href = `read.html?title=${encodeURIComponent(query)}`;
        }
      }
    });
  </script>
</body>
</html>
