<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¬¸ì„œ ë§Œë“¤ê¸° - Birdwiki</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
</head>
<body>
  <div class="container">
    <h1>ë¬¸ì„œ ë§Œë“¤ê¸°</h1>
    <form id="document-form">
      <input type="text" id="title" placeholder="ì œëª©" required />
      <input type="text" id="koreanName" placeholder="í•œêµ­ì–´ ì´ë¦„" />
      <input type="text" id="scientificName" placeholder="í•™ëª…" />
      <input type="text" id="englishName" placeholder="ì˜ë¬¸ ì´ë¦„" />
      <input type="text" id="order" placeholder="ëª© (Order)" />
      <input type="text" id="family" placeholder="ê³¼ (Family)" />
      <input type="text" id="genus" placeholder="ì† (Genus)" />

      <label for="cover">ëŒ€í‘œ ì´ë¯¸ì§€</label>
      <input type="file" id="cover" accept="image/*" />
      <input type="hidden" id="cover-url" />
      <button type="button" id="delete-cover">ëŒ€í‘œ ì´ë¯¸ì§€ ì‚­ì œ</button>

      <div id="sections"></div>
      <button type="button" id="add-section">ì†Œì œëª© ì¶”ê°€</button>
      <button type="submit">ì €ì¥</button>
    </form>
  </div>

  <script>
    const isEdit = new URLSearchParams(location.search).get('edit') === 'true';
    const existingData = JSON.parse(localStorage.getItem('editData') || '{}');

    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      const res = await fetch('https://birdwiki.onrender.com/api/upload', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      return data.imageUrl;
    }

    function createSection(data = {}) {
      const container = document.createElement('div');
      container.className = 'section';

      const heading = document.createElement('input');
      heading.placeholder = 'ì†Œì œëª©';
      heading.className = 'section-heading';
      heading.value = data.heading || '';

      const text = document.createElement('textarea');
      text.placeholder = 'ë‚´ìš©';
      text.className = 'section-text';
      text.value = data.text || '';

      const imageInput = document.createElement('input');
      imageInput.type = 'file';
      imageInput.accept = 'image/*';

      const imageUrl = document.createElement('input');
      imageUrl.type = 'hidden';
      imageUrl.className = 'section-image';
      imageUrl.value = data.image || '';

      const imagePreview = document.createElement('img');
      imagePreview.style.maxWidth = '200px';
      imagePreview.style.display = data.image ? 'block' : 'none';
      if (data.image) imagePreview.src = data.image;

      const caption = document.createElement('input');
      caption.placeholder = 'ì´ë¯¸ì§€ ìº¡ì…˜';
      caption.className = 'section-caption';
      caption.value = data.caption || '';

      const references = document.createElement('textarea');
      references.placeholder = 'ì°¸ê³ ë¬¸í—Œ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)';
      references.className = 'section-refs';
      references.value = (data.references || []).join('\n');

      const deleteImageBtn = document.createElement('button');
      deleteImageBtn.textContent = 'ì´ë¯¸ì§€ ì‚­ì œ';
      deleteImageBtn.type = 'button';
      deleteImageBtn.onclick = () => {
        imageInput.value = '';
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        imageUrl.value = '';
      };

      const deleteSectionBtn = document.createElement('button');
      deleteSectionBtn.textContent = 'ì†Œì œëª© ì‚­ì œ';
      deleteSectionBtn.type = 'button';
      deleteSectionBtn.onclick = () => container.remove();

      imageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const uploaded = await uploadImage(file);
        imageUrl.value = uploaded;
        imagePreview.src = uploaded;
        imagePreview.style.display = 'block';
      });

      container.append(heading, text, imageInput, imagePreview, imageUrl, caption, references, deleteImageBtn, deleteSectionBtn);
      document.getElementById('sections').appendChild(container);
    }

    document.getElementById('add-section').addEventListener('click', () => createSection());

    if (isEdit && existingData) {
      document.getElementById('title').value = existingData.title || '';
      document.getElementById('koreanName').value = existingData.koreanName || '';
      document.getElementById('scientificName').value = existingData.scientificName || '';
      document.getElementById('englishName').value = existingData.englishName || '';
      document.getElementById('order').value = existingData.order || '';
      document.getElementById('family').value = existingData.family || '';
      document.getElementById('genus').value = existingData.genus || '';
      document.getElementById('cover-url').value = existingData.coverImage || '';
      (existingData.content || []).forEach(createSection);
    }

    document.getElementById('cover').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const uploaded = await uploadImage(file);
      document.getElementById('cover-url').value = uploaded;
    });

    document.getElementById('delete-cover').addEventListener('click', () => {
      document.getElementById('cover').value = '';
      document.getElementById('cover-url').value = '';
    });

    document.getElementById('document-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        title: document.getElementById('title').value.trim(),
        koreanName: document.getElementById('koreanName').value,
        scientificName: document.getElementById('scientificName').value,
        englishName: document.getElementById('englishName').value,
        order: document.getElementById('order').value,
        family: document.getElementById('family').value,
        genus: document.getElementById('genus').value,
        coverImage: document.getElementById('cover-url').value || null,
        content: Array.from(document.querySelectorAll('.section')).map(section => ({
          heading: section.querySelector('.section-heading').value,
          text: section.querySelector('.section-text').value,
          image: section.querySelector('.section-image').value,
          caption: section.querySelector('.section-caption').value,
          references: section.querySelector('.section-refs').value
            .split('\n')
            .map(r => r.trim())
            .filter(Boolean)
        }))
      };




      try {
        const url = isEdit ? '/api/update' : '/api/create';

        console.log('ğŸ§ª ìµœì¢… fetch URL:', url); // urlë§Œ ì¶œë ¥í•´ë„ ì¶©ë¶„í•´
        
        const res = await fetch(`https://birdwiki.onrender.com${url}`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload)
});
        if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');

        alert('âœ… ë¬¸ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.href = 'read.html?title=' + encodeURIComponent(payload.title);
      } catch (err) {
        console.error(err);
        alert('âŒ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
      }
    });
  </script>

<script>
  const headerInput = document.getElementById('headerSearchInput');
  const headerSuggestions = document.getElementById('headerSuggestions');

  if (headerInput) {
    headerInput.addEventListener('input', async () => {
      const keyword = headerInput.value.trim();
      if (!keyword) {
        headerSuggestions.innerHTML = '';
        return;
      }

      try {
        const res = await fetch(`https://birdwiki.onrender.com/api/suggest?q=${encodeURIComponent(keyword)}`);
        const titles = await res.json();
        headerSuggestions.innerHTML = '';
        titles.forEach(title => {
          const li = document.createElement('li');
          li.textContent = title;
          li.className = 'suggestion-item';
          li.addEventListener('click', () => {
            window.location.href = `read.html?title=${encodeURIComponent(title)}`;
          });
          headerSuggestions.appendChild(li);
        });
      } catch (err) {
        console.error("ì¶”ì²œ ê²€ìƒ‰ì–´ ì‹¤íŒ¨", err);
      }
    });

    headerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const keyword = headerInput.value.trim();
        if (keyword) {
          window.location.href = `read.html?title=${encodeURIComponent(keyword)}`;
        }
      }
    });
  }
</script>

</body>
</html>
