<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>문서 만들기 - Birdwiki</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
</head>
<body>
  <div class="container">
    <h1>문서 만들기</h1>
    <form id="document-form">
      <input type="text" id="title" placeholder="제목" required />
      <input type="text" id="koreanName" placeholder="한국어 이름" />
      <input type="text" id="scientificName" placeholder="학명" />
      <input type="text" id="englishName" placeholder="영문 이름" />
      <input type="text" id="order" placeholder="목 (Order)" />
      <input type="text" id="family" placeholder="과 (Family)" />
      <input type="text" id="genus" placeholder="속 (Genus)" />

      <label for="cover">대표 이미지</label>
      <input type="file" id="cover" accept="image/*" />
      <input type="hidden" id="cover-url" />
      <button type="button" id="delete-cover">대표 이미지 삭제</button>

      <div id="sections"></div>
      <button type="button" id="add-section">소제목 추가</button>
      <button type="submit">저장</button>
    </form>
  </div>

  <script>
    const isEdit = new URLSearchParams(location.search).get('edit') === 'true';
    const existingData = JSON.parse(localStorage.getItem('editData') || '{}');

    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      const res = await fetch('https://birdwiki.onrender.com/api/upload', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      return data.imageUrl;
    }

    function createSection(data = {}) {
      const container = document.createElement('div');
      container.className = 'section';

      const heading = document.createElement('input');
      heading.placeholder = '소제목';
      heading.className = 'section-heading';
      heading.value = data.heading || '';

      const text = document.createElement('textarea');
      text.placeholder = '내용';
      text.className = 'section-text';
      text.value = data.text || '';

      const imageInput = document.createElement('input');
      imageInput.type = 'file';
      imageInput.accept = 'image/*';

      const imageUrl = document.createElement('input');
      imageUrl.type = 'hidden';
      imageUrl.className = 'section-image';
      imageUrl.value = data.image || '';

      const imagePreview = document.createElement('img');
      imagePreview.style.maxWidth = '200px';
      imagePreview.style.display = data.image ? 'block' : 'none';
      if (data.image) imagePreview.src = data.image;

      const caption = document.createElement('input');
      caption.placeholder = '이미지 캡션';
      caption.className = 'section-caption';
      caption.value = data.caption || '';

      const references = document.createElement('textarea');
      references.placeholder = '참고문헌 (줄바꿈으로 구분)';
      references.className = 'section-refs';
      references.value = (data.references || []).join('\n');

      const deleteImageBtn = document.createElement('button');
      deleteImageBtn.textContent = '이미지 삭제';
      deleteImageBtn.type = 'button';
      deleteImageBtn.onclick = () => {
        imageInput.value = '';
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        imageUrl.value = '';
      };

      const deleteSectionBtn = document.createElement('button');
      deleteSectionBtn.textContent = '소제목 삭제';
      deleteSectionBtn.type = 'button';
      deleteSectionBtn.onclick = () => container.remove();

      imageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const uploaded = await uploadImage(file);
        imageUrl.value = uploaded;
        imagePreview.src = uploaded;
        imagePreview.style.display = 'block';
      });

      container.append(heading, text, imageInput, imagePreview, imageUrl, caption, references, deleteImageBtn, deleteSectionBtn);
      document.getElementById('sections').appendChild(container);
    }

    document.getElementById('add-section').addEventListener('click', () => createSection());

    if (isEdit && existingData) {
      document.getElementById('title').value = existingData.title || '';
      document.getElementById('koreanName').value = existingData.koreanName || '';
      document.getElementById('scientificName').value = existingData.scientificName || '';
      document.getElementById('englishName').value = existingData.englishName || '';
      document.getElementById('order').value = existingData.order || '';
      document.getElementById('family').value = existingData.family || '';
      document.getElementById('genus').value = existingData.genus || '';
      document.getElementById('cover-url').value = existingData.coverImage || '';
      (existingData.content || []).forEach(createSection);
    }

    document.getElementById('cover').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const uploaded = await uploadImage(file);
      document.getElementById('cover-url').value = uploaded;
    });

    document.getElementById('delete-cover').addEventListener('click', () => {
      document.getElementById('cover').value = '';
      document.getElementById('cover-url').value = '';
    });

    document.getElementById('document-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        title: document.getElementById('title').value.trim(),
        koreanName: document.getElementById('koreanName').value,
        scientificName: document.getElementById('scientificName').value,
        englishName: document.getElementById('englishName').value,
        order: document.getElementById('order').value,
        family: document.getElementById('family').value,
        genus: document.getElementById('genus').value,
        coverImage: document.getElementById('cover-url').value || null,
        content: Array.from(document.querySelectorAll('.section')).map(section => ({
          heading: section.querySelector('.section-heading').value,
          text: section.querySelector('.section-text').value,
          image: section.querySelector('.section-image').value,
          caption: section.querySelector('.section-caption').value,
          references: section.querySelector('.section-refs').value
            .split('\n')
            .map(r => r.trim())
            .filter(Boolean)
        }))
      };




      try {
        const url = isEdit ? '/api/update' : '/api/create';

        console.log('🧪 최종 fetch URL:', url); // url만 출력해도 충분해
        
        const res = await fetch(`https://birdwiki.onrender.com${url}`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload)
});
        if (!res.ok) throw new Error('서버 오류 발생');

        alert('✅ 문서가 성공적으로 저장되었습니다.');
        location.href = 'read.html?title=' + encodeURIComponent(payload.title);
      } catch (err) {
        console.error(err);
        alert('❌ 서버 오류 발생');
      }
    });
  </script>

<script>
  const headerInput = document.getElementById('headerSearchInput');
  const headerSuggestions = document.getElementById('headerSuggestions');

  if (headerInput) {
    headerInput.addEventListener('input', async () => {
      const keyword = headerInput.value.trim();
      if (!keyword) {
        headerSuggestions.innerHTML = '';
        return;
      }

      try {
        const res = await fetch(`https://birdwiki.onrender.com/api/suggest?q=${encodeURIComponent(keyword)}`);
        const titles = await res.json();
        headerSuggestions.innerHTML = '';
        titles.forEach(title => {
          const li = document.createElement('li');
          li.textContent = title;
          li.className = 'suggestion-item';
          li.addEventListener('click', () => {
            window.location.href = `read.html?title=${encodeURIComponent(title)}`;
          });
          headerSuggestions.appendChild(li);
        });
      } catch (err) {
        console.error("추천 검색어 실패", err);
      }
    });

    headerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const keyword = headerInput.value.trim();
        if (keyword) {
          window.location.href = `read.html?title=${encodeURIComponent(keyword)}`;
        }
      }
    });
  }
</script>

</body>
</html>
